<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Klondike Solitaire</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
  /* â”€â”€ ĞšĞĞ Ğ¢Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card { position:relative; cursor:pointer; flex-shrink:0; }

  .card-face {
    position:absolute; inset:0; border-radius:9px;
    background:#fff; border:1px solid rgba(0,0,0,.13);
    box-shadow:0 2px 8px rgba(0,0,0,.28);
    overflow:hidden;
  }
  .card.red  .card-face { color:#d62828; }
  .card.black .card-face { color:#111; }

  /* Ğ£Ğ³Ğ»Ğ¾Ğ²Ñ‹Ğµ Ğ¼ĞµÑ‚ĞºĞ¸ â€” ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ */
  .cc { position:absolute; display:flex; flex-direction:column; align-items:center; line-height:1.05; }
  .cc.tl { top:3px; left:5px; }
  .cc.br { bottom:3px; right:5px; transform:rotate(180deg); }
  .cc .r  { font-size:.82rem; font-weight:900; }
  .cc .s  { font-size:.72rem; }

  /* Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ° */
  .card-mid {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    font-size:1.9rem; line-height:1; pointer-events:none;
  }
  .card-royal-art {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    font-size:2.6rem; line-height:1; pointer-events:none;
  }

  /* Ğ ÑƒĞ±Ğ°ÑˆĞºĞ° */
  .card-back {
    position:absolute; inset:0; border-radius:9px;
    background:repeating-linear-gradient(45deg,#b91c1c,#b91c1c 5px,#991818 5px,#991818 10px);
    border:3px solid #7f1d1d;
    box-shadow:0 2px 8px rgba(0,0,0,.3);
  }
  .card-back::after {
    content:''; position:absolute; inset:5px; border-radius:5px;
    border:2px solid rgba(255,255,255,.22);
  }

  /* Ğ’Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ */
  .card.selected .card-face,
  .card.selected .card-back {
    outline:3px solid #f5a623;
    box-shadow:0 0 0 3px #f5a623, 0 10px 28px rgba(0,0,0,.55) !important;
    transform:translateY(-8px);
  }

  /* ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° */
  .card.hint-glow .card-face {
    outline:3px solid #22d3ee;
    animation:hpulse .7s ease-in-out infinite alternate;
  }
  .pile-slot.hint-glow,
  .tableau-col.hint-glow {
    border-color:#22d3ee !important;
    animation:hpulse .7s ease-in-out infinite alternate;
  }
  @keyframes hpulse {
    from { box-shadow:0 0 0 3px #22d3ee; }
    to   { box-shadow:0 0 0 6px #0ea5e9, 0 0 22px rgba(14,165,233,.5); }
  }

  /* Ğ›ĞµÑ‚ÑÑ‰Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° (Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ) */
  .card-fly {
    position:fixed; z-index:9999; pointer-events:none;
    will-change:transform;
    transition:transform .26s cubic-bezier(.4,0,.2,1),
               opacity   .26s ease;
  }

  /* â”€â”€ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ• Ğ¡Ğ¢Ğ˜Ğ›Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
    background:#1a6b3a; color:#fff; min-height:100vh; user-select:none;
    -webkit-user-select:none; touch-action:manipulation; }
  .hidden { display:none !important; }

  /* Ğ­ĞºÑ€Ğ°Ğ½ Ğ¸Ğ¼ĞµĞ½Ğ¸ */
  .name-screen { display:flex; align-items:center; justify-content:center; min-height:100vh;
    background:radial-gradient(ellipse at center,#236b45 0%,#0d3a20 100%); }
  .name-card { background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.15);
    border-radius:20px; padding:48px 40px; text-align:center; width:min(400px,90vw);
    backdrop-filter:blur(12px); }
  .name-card h1 { font-size:2rem; margin-bottom:10px; }
  .name-card p  { color:rgba(255,255,255,.7); margin-bottom:28px; }
  .name-card input { width:100%; padding:14px 18px; font-size:1.1rem;
    border:2px solid rgba(255,255,255,.25); border-radius:12px;
    background:rgba(255,255,255,.1); color:#fff; outline:none;
    margin-bottom:16px; transition:border-color .2s; }
  .name-card input::placeholder { color:rgba(255,255,255,.4); }
  .name-card input:focus { border-color:rgba(255,255,255,.6); }
  .btn-primary { display:block; width:100%; padding:14px; font-size:1.1rem; font-weight:600;
    background:linear-gradient(135deg,#f5a623,#e8891a); color:#fff; border:none;
    border-radius:12px; cursor:pointer; transition:opacity .2s,transform .1s; }
  .btn-primary:hover  { opacity:.92; }
  .btn-primary:active { transform:scale(.98); }
  .btn-secondary { padding:10px 24px; font-size:1rem; background:rgba(255,255,255,.15);
    color:#fff; border:1px solid rgba(255,255,255,.3); border-radius:10px;
    cursor:pointer; transition:background .2s; }
  .btn-secondary:hover { background:rgba(255,255,255,.25); }
  .stats-link { display:inline-block; margin-top:16px; color:rgba(255,255,255,.6);
    text-decoration:none; font-size:.95rem; transition:color .2s; }
  .stats-link:hover { color:#fff; }

  /* Ğ˜Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ÑĞºÑ€Ğ°Ğ½ */
  .game-screen { display:flex; flex-direction:column; height:100vh; max-height:100vh;
    background:#1a6b3a; }

  /* Header */
  .game-header { display:flex; align-items:center; justify-content:space-between;
    padding:8px 16px; background:rgba(0,0,0,.3);
    border-bottom:1px solid rgba(255,255,255,.1); flex-shrink:0; gap:8px; }
  .header-stat { display:flex; flex-direction:column; align-items:flex-start; min-width:70px; }
  .header-stat.center { align-items:center; flex:1; }
  .header-stat.right  { align-items:flex-end; }
  .stat-label { font-size:.65rem; text-transform:uppercase; letter-spacing:.07em; color:rgba(255,255,255,.6); }
  .stat-value { font-size:1.35rem; font-weight:700; }
  .header-stats-link { display:flex; align-items:center; gap:5px; padding:6px 12px;
    background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15);
    border-radius:10px; color:#fff; text-decoration:none; font-size:.8rem;
    font-weight:600; transition:background .2s; white-space:nowrap; }
  .header-stats-link:hover { background:rgba(255,255,255,.2); }

  /* Ğ˜Ğ³Ñ€Ğ¾Ğ²Ğ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ */
  .game-area { flex:1; overflow-y:auto; padding:12px 8px 4px;
    display:flex; flex-direction:column; gap:12px; }
  .top-row { display:flex; align-items:flex-start; justify-content:space-between; gap:6px; }
  .foundations-row { display:flex; gap:6px; }
  .stock-area { display:flex; gap:6px; align-items:flex-start; }

  /* Ğ¡Ğ»Ğ¾Ñ‚Ñ‹ */
  .pile-slot { width:72px; height:104px; border-radius:9px;
    border:2px dashed rgba(255,255,255,.28);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; flex-shrink:0; transition:border-color .2s; position:relative; }
  .pile-slot:hover { border-color:rgba(255,255,255,.5); }
  .pile-suit       { font-size:2rem; opacity:.28; }
  .pile-empty-icon { font-size:1.4rem; opacity:.32; font-weight:700; }

  /* Waste â€” Ñ‚Ñ€Ğ¸ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ»ĞµÑĞµĞ½ĞºĞ¾Ğ¹ */
  .waste-wrap { position:relative; height:104px; flex-shrink:0; }
  .waste-wrap .card { position:absolute; top:0; }

  /* Tableau */
  .tableau-row { display:flex; gap:6px; justify-content:center; padding-bottom:20px; }
  .tableau-col { position:relative; width:72px; min-height:104px; flex-shrink:0; }
  .tableau-col-bg { position:absolute; inset:0; border-radius:9px;
    border:2px dashed rgba(255,255,255,.2);
    display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .pile-slot.drop-ok, .tableau-col.drop-ok { border-color:#22d3ee !important; border-style:solid !important; }

  /* Footer */
  .game-footer { display:flex; gap:8px; padding:10px 12px 14px;
    background:rgba(0,0,0,.3); border-top:1px solid rgba(255,255,255,.1); flex-shrink:0; }
  .footer-btn { flex:1; display:flex; flex-direction:column; align-items:center;
    justify-content:center; gap:3px; padding:9px 4px;
    background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15);
    border-radius:14px; color:#fff; font-size:.78rem; font-weight:600;
    cursor:pointer; transition:background .2s,transform .1s; }
  .footer-btn:hover  { background:rgba(255,255,255,.2); }
  .footer-btn:active { transform:scale(.96); }
  .footer-btn.primary { background:rgba(245,166,35,.3); border-color:rgba(245,166,35,.5); }
  .footer-btn.primary:hover { background:rgba(245,166,35,.45); }
  .btn-icon { font-size:1.35rem; }

  /* ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ¸ */
  .modal { position:fixed; inset:0; background:rgba(0,0,0,.65);
    display:flex; align-items:center; justify-content:center;
    z-index:200; backdrop-filter:blur(4px); }
  .modal-content { background:linear-gradient(145deg,#1e4d30,#153a23);
    border:1px solid rgba(255,255,255,.2); border-radius:20px;
    padding:34px 30px; text-align:center; width:min(360px,88vw);
    box-shadow:0 24px 60px rgba(0,0,0,.6); }
  .modal-content.sm { padding:26px 22px; }
  .win-emoji { font-size:3.2rem; margin-bottom:8px; }
  .modal-content h2 { font-size:1.7rem; margin-bottom:18px; }
  .modal-content p { color:rgba(255,255,255,.75); margin-bottom:18px; line-height:1.5; }
  .win-stats { display:flex; gap:14px; justify-content:center; margin-bottom:26px; }
  .win-stat { display:flex; flex-direction:column; gap:4px; }
  .win-stat span   { font-size:.72rem; color:rgba(255,255,255,.6); text-transform:uppercase; }
  .win-stat strong { font-size:1.35rem; }
  .modal-btns { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  .modal-btns .btn-primary  { width:auto; padding:10px 22px; }
  .modal-btns .btn-secondary{ padding:10px 22px; }

  .dragging { opacity:.3 !important; }

  /* ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² Ğ¼Ğ¾Ğ±Ğ°Ğ¹Ğ» */
  @media(max-width:500px){
    .pile-slot { width:46px; height:68px; }
    .waste-wrap { height:68px; }
    .tableau-col { width:46px; min-height:68px; }
    .tableau-col-bg { border-radius:6px; }
    .tableau-row,.foundations-row,.stock-area,.top-row { gap:3px; }
    .cc .r { font-size:.6rem; }
    .cc .s { font-size:.55rem; }
    .card-mid,.card-royal-art { font-size:1.3rem; }
  }
  </style>
</head>
<body>

<!-- â”€â”€ Ğ­ĞšĞ ĞĞ Ğ˜ĞœĞ•ĞĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="name-screen" class="name-screen">
  <div class="name-card">
    <h1>ğŸƒ Klondike Solitaire</h1>
    <p>Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ</p>
    <input type="text" id="player-name-input" placeholder="Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ" maxlength="30"/>
    <button id="start-btn" class="btn-primary">Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ</button>
    <a href="stats.html" class="stats-link">ğŸ“Š Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¾Ğ²</a>
  </div>
</div>

<!-- â”€â”€ Ğ˜Ğ“Ğ ĞĞ’ĞĞ™ Ğ­ĞšĞ ĞĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="game-screen" class="game-screen hidden">
  <header class="game-header">
    <div class="header-stat">
      <span class="stat-label">ĞÑ‡ĞºĞ¸</span>
      <span class="stat-value" id="score-display">0</span>
    </div>
    <div class="header-stat center">
      <span class="stat-value" id="timer-display">00:00</span>
    </div>
    <div class="header-stat right">
      <span class="stat-label">Ğ¥Ğ¾Ğ´Ñ‹</span>
      <span class="stat-value" id="moves-display">0</span>
    </div>
    <a href="stats.html" class="header-stats-link">ğŸ“Š Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³</a>
  </header>

  <main class="game-area">
    <div class="top-row">
      <div class="foundations-row">
        <div class="pile-slot" id="f0"><span class="pile-suit">â™ </span></div>
        <div class="pile-slot" id="f1"><span class="pile-suit">â™¥</span></div>
        <div class="pile-slot" id="f2"><span class="pile-suit">â™¦</span></div>
        <div class="pile-slot" id="f3"><span class="pile-suit">â™£</span></div>
      </div>
      <div class="stock-area">
        <div class="pile-slot" id="stock"><span class="pile-empty-icon">â†º</span></div>
        <div class="waste-wrap" id="waste"></div>
      </div>
    </div>
    <div class="tableau-row" id="tableau"></div>
  </main>

  <footer class="game-footer">
    <button class="footer-btn" id="undo-btn"><span class="btn-icon">â†©</span><span>ĞÑ‚Ğ¼ĞµĞ½Ğ°</span></button>
    <button class="footer-btn primary" id="new-game-btn"><span class="btn-icon">ğŸƒ</span><span>ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°</span></button>
    <button class="footer-btn" id="hint-btn"><span class="btn-icon">ğŸ’¡</span><span>ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°</span></button>
  </footer>
</div>

<!-- â”€â”€ ĞœĞĞ”ĞĞ›ĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="win-modal" class="modal hidden">
  <div class="modal-content">
    <div class="win-emoji">ğŸ‰</div>
    <h2>ĞŸĞ¾Ğ±ĞµĞ´Ğ°!</h2>
    <div class="win-stats">
      <div class="win-stat"><span>ĞÑ‡ĞºĞ¸</span><strong id="win-score"></strong></div>
      <div class="win-stat"><span>Ğ’Ñ€ĞµĞ¼Ñ</span><strong id="win-time"></strong></div>
      <div class="win-stat"><span>Ğ¥Ğ¾Ğ´Ñ‹</span><strong id="win-moves"></strong></div>
    </div>
    <div class="modal-btns">
      <button class="btn-primary" id="win-new-game">ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°</button>
      <a href="stats.html" class="btn-secondary" style="text-decoration:none;display:inline-flex;align-items:center">ğŸ“Š Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³</a>
    </div>
  </div>
</div>

<div id="auto-modal" class="modal hidden">
  <div class="modal-content sm">
    <div style="font-size:2rem;margin-bottom:8px">ğŸ¤–</div>
    <h2>ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ°!</h2>
    <p>Ğ’ÑĞµ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹ â€” Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸?</p>
    <div class="modal-btns">
      <button class="btn-primary" id="auto-yes">Ğ”Ğ°, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ</button>
      <button class="btn-secondary" id="auto-no">ĞĞµÑ‚, ÑĞ°Ğ¼</button>
    </div>
  </div>
</div>

<div id="cfg-modal" class="modal hidden">
  <div class="modal-content sm">
    <div id="cfg-icon" style="font-size:2rem;margin-bottom:8px">ğŸ”„</div>
    <h2 id="cfg-title">ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°?</h2>
    <p id="cfg-text">Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ±ĞµĞ· ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.</p>
    <div class="modal-btns">
      <button class="btn-primary" id="cfg-yes">Ğ”Ğ°</button>
      <button class="btn-secondary" id="cfg-no">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =============================================
//  ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ SUPABASE
//  â–¼â–¼â–¼ Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ• Ğ­Ğ¢Ğ˜ Ğ—ĞĞĞ§Ğ•ĞĞ˜Ğ¯ ĞĞ Ğ¡Ğ’ĞĞ˜ â–¼â–¼â–¼
// =============================================
const SUPABASE_URL = 'https://ncdajiaffqbmqamrpsfz.supabase.co'
const SUPABASE_KEY = 'sb_publishable_YxIguOiNADys-g1G6teUwA_qtKYEV6e'
// =============================================
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// â”€â”€ ĞšĞĞĞ¡Ğ¢ĞĞĞ¢Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUITS = ['â™ ','â™¥','â™¦','â™£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RED   = new Set(['â™¥','â™¦']);
const ROYALS = {
  'Jâ™ ':'ğŸ§™','Jâ™¥':'ğŸ¤´','Jâ™¦':'ğŸ¤µ','Jâ™£':'ğŸ§',
  'Qâ™ ':'ğŸ‘¸','Qâ™¥':'ğŸ‘©â€ğŸ¦°','Qâ™¦':'ğŸ§â€â™€ï¸','Qâ™£':'ğŸ§œâ€â™€ï¸',
  'Kâ™ ':'ğŸ‘‘','Kâ™¥':'ğŸ¤´','Kâ™¦':'ğŸ‘¨â€ğŸ¦³','Kâ™£':'ğŸ§™â€â™‚ï¸'
};
const isRed = s => RED.has(s);
const ri    = r => RANKS.indexOf(r);
const clone = o => JSON.parse(JSON.stringify(o));

const CW  = () => window.innerWidth <= 500 ? 46 : 72;
const CH  = () => window.innerWidth <= 500 ? 68 : 104;
const OV  = () => window.innerWidth <= 500 ? 20 : 28;
const WOF = () => window.innerWidth <= 500 ? 13 : 18;

const SC = { W2T:5, W2F:10, T2F:10, FLIP:5, STOCK:-2, F2T:-15 };

// â”€â”€ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playerName='', playerId=null;
let stock=[], waste=[], found=[[],[],[],[]], tab=[[],[],[],[],[],[],[]];
let score=0, moves=0, secs=0;
let tint=null, hist=[], sel=null, hintEls=[];
let autoOffered=false, cfgCb=null;

function buildDeck(){return SUITS.flatMap(s=>RANKS.map(r=>({suit:s,rank:r,up:false})));}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function snap(){hist.push({stock:clone(stock),waste:clone(waste),found:clone(found),tab:clone(tab),score,moves});if(hist.length>120)hist.shift();}

// â”€â”€ Ğ ĞĞ—Ğ”ĞĞ§Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deal(){
  clearInterval(tint);
  const deck=shuffle(buildDeck());
  tab=[[],[],[],[],[],[],[]]; found=[[],[],[],[]];
  waste=[]; stock=[]; score=0; moves=0; secs=0; hist=[];
  sel=null; hintEls=[]; autoOffered=false;
  let idx=0;
  for(let c=0;c<7;c++) for(let r=0;r<=c;r++){const cd=deck[idx++];cd.up=(r===c);tab[c].push(cd);}
  while(idx<deck.length) stock.push(deck[idx++]);
  render();
  updateTimer();
  tint=setInterval(()=>{secs++;updateTimer();},1000);
}

function updateTimer(){
  const m=String(Math.floor(secs/60)).padStart(2,'0');
  const s=String(secs%60).padStart(2,'0');
  document.getElementById('timer-display').textContent=m+':'+s;
}

// â”€â”€ Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• ĞšĞĞ Ğ¢Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkCard(card){
  const cw=CW(), ch=CH();
  const el=document.createElement('div');
  el.className='card '+(isRed(card.suit)?'red':'black');
  el.style.width=cw+'px'; el.style.height=ch+'px';
  el.dataset.r=card.rank; el.dataset.s=card.suit;

  if(!card.up){
    const b=document.createElement('div');b.className='card-back';el.appendChild(b);return el;
  }

  const face=document.createElement('div'); face.className='card-face';

  // Ğ›ĞµĞ²Ñ‹Ğ¹ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ ÑƒĞ³Ğ¾Ğ»
  const tl=document.createElement('div'); tl.className='cc tl';
  tl.innerHTML='<span class="r">'+card.rank+'</span><span class="s">'+card.suit+'</span>';

  // ĞŸÑ€Ğ°Ğ²Ñ‹Ğ¹ Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğ¹ ÑƒĞ³Ğ¾Ğ»
  const br=document.createElement('div'); br.className='cc br';
  br.innerHTML='<span class="r">'+card.rank+'</span><span class="s">'+card.suit+'</span>';

  face.appendChild(tl); face.appendChild(br);

  // Ğ¦ĞµĞ½Ñ‚Ñ€: Ñ„Ğ¸Ğ³ÑƒÑ€Ğ° Ğ¸Ğ»Ğ¸ Ğ¼Ğ°ÑÑ‚ÑŒ
  const key=card.rank+card.suit;
  const mid=document.createElement('span');
  if(ROYALS[key]){mid.className='card-royal-art';mid.textContent=ROYALS[key];}
  else{mid.className='card-mid';mid.textContent=card.suit;}
  face.appendChild(mid);

  el.appendChild(face);
  return el;
}

// â”€â”€ Ğ Ğ•ĞĞ”Ğ•Ğ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  renderStock(); renderWaste(); renderFound(); renderTab();
  document.getElementById('score-display').textContent=Math.max(0,score);
  document.getElementById('moves-display').textContent=moves;
}

function renderStock(){
  const el=document.getElementById('stock'); el.innerHTML='';
  if(stock.length>0){
    const c=mkCard({suit:'â™ ',rank:'A',up:false}); c.style.position='absolute'; el.appendChild(c);
  } else {
    el.innerHTML='<span class="pile-empty-icon">â†º</span>';
  }
  el.onclick=onStockClick;
  attachTouch(el,()=>onStockClick());
}

function onStockClick(){
  clearHints(); clearSel(); snap();
  if(!stock.length){stock=waste.slice().reverse().map(c=>({...c,up:false}));waste=[];moves++;render();return;}
  const cd=stock.pop(); cd.up=true; waste.push(cd);
  score=Math.max(0,score+SC.STOCK); moves++; render();
}

function renderWaste(){
  const cont=document.getElementById('waste'); cont.innerHTML='';
  const cw=CW(), wof=WOF(), show=Math.min(3,waste.length);
  // Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ¿Ğ¾Ğ´ Ğ²ÑĞµ 3 ĞºĞ°Ñ€Ñ‚Ñ‹
  cont.style.width=cw+(show>1?(show-1)*wof:0)+'px';
  for(let i=show-1;i>=0;i--){
    const card=waste[waste.length-1-i];
    const el=mkCard(card); el.style.position='absolute';
    el.style.left=(show-1-i)*wof+'px'; el.style.zIndex=show-i;
    if(i===0){ // Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ĞµÑ€Ñ…Ğ½ÑÑ ĞºĞ°Ñ€Ñ‚Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°
      el.onclick=()=>onWasteClick(el,card);
      setupPointerDrag(el,[card],'waste',-1);
    }
    cont.appendChild(el);
  }
}

function renderFound(){
  for(let i=0;i<4;i++){
    const el=document.getElementById('f'+i); el.innerHTML='';
    if(found[i].length>0){
      const c=mkCard(found[i][found[i].length-1]); c.style.position='absolute'; el.appendChild(c);
    } else {
      el.innerHTML='<span class="pile-suit">'+SUITS[i]+'</span>';
    }
    el.onclick=()=>onFoundClick(i);
    setupDropTarget(el,
      cards=>cards.length===1&&canF(cards[0],i),
      ()=>{if(sel)doF(sel.cards[0],i,sel.fromPile,sel.fromIdx);}
    );
  }
}

function renderTab(){
  const cont=document.getElementById('tableau'); cont.innerHTML='';
  const cw=CW(), ch=CH(), ov=OV();
  for(let col=0;col<7;col++){
    const colEl=document.createElement('div'); colEl.className='tableau-col'; colEl.dataset.col=col;
    const bg=document.createElement('div'); bg.className='tableau-col-bg';
    bg.innerHTML='<span style="font-size:.85rem;opacity:.18">K</span>'; colEl.appendChild(bg);
    colEl.style.width=cw+'px';
    colEl.style.height=tab[col].length>0?(tab[col].length-1)*ov+ch+'px':ch+'px';

    for(let row=0;row<tab[col].length;row++){
      const card=tab[col][row];
      const cEl=mkCard(card); cEl.style.position='absolute';
      cEl.style.top=row*ov+'px'; cEl.style.zIndex=row+1; cEl.style.width=cw+'px';
      if(card.up){
        cEl.onclick=()=>onTabClick(col,row);
        setupPointerDrag(cEl,tab[col].slice(row),'tableau',col);
      }
      colEl.appendChild(cEl);
    }

    setupDropTarget(colEl,
      cards=>canT(cards[0],col),
      ()=>{if(!sel)return;snap();const from=sel,cards=sel.cards;removeFrom(from);tab[col].push(...cards);
           if(from.fromPile==='waste')score+=SC.W2T;else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
           moves++;clearSel();render();checkAuto();}
    );
    colEl.onclick=e=>{if(e.target===colEl||e.target===bg||e.target.classList.contains('tableau-col-bg'))onTabEmpty(col);};
    cont.appendChild(colEl);
  }
}

// â”€â”€ ĞšĞ›Ğ˜Ğš: WASTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onWasteClick(el,card){
  clearHints();
  // ĞĞ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´ Ğ½Ğ° Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚
  for(let i=0;i<4;i++){
    if(canF(card,i)){
      fly(el,document.getElementById('f'+i),()=>{snap();waste.pop();found[i].push(card);score+=SC.W2F;moves++;render();checkWin();checkAuto();});
      return;
    }
  }
  // ĞĞ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´ Ğ² tableau
  for(let c=0;c<7;c++){
    if(canT(card,c)){
      fly(el,tabColEl(c),()=>{snap();waste.pop();tab[c].push(card);score+=SC.W2T;moves++;render();checkAuto();});
      return;
    }
  }
  // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ
  if(sel?.fromPile==='waste'){clearSel();return;}
  el.classList.add('selected');
  sel={cards:[card],fromPile:'waste',fromIdx:-1};
}

// â”€â”€ ĞšĞ›Ğ˜Ğš: TABLEAU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTabClick(col,row){
  clearHints();
  const card=tab[col][row];

  // Ğ•ÑÑ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ â€” Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ
  if(sel){
    if(canT(sel.cards[0],col)){
      const srcEl=getSelEl();
      fly(srcEl,tabColEl(col),()=>{
        snap(); const from=sel,cards=sel.cards; removeFrom(from);
        tab[col].push(...cards);
        if(from.fromPile==='waste')score+=SC.W2T;
        else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
        moves++; clearSel(); render(); checkAuto();
      });
      return;
    }
    // ĞĞµ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ â€” ÑĞ½ÑÑ‚ÑŒ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ, Ğ¸ ĞµÑĞ»Ğ¸ ĞºĞ°Ñ€Ñ‚Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ° â€” Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ĞµÑ‘
    clearSel();
    if(!card.up)return;
    // Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ â€” Ğ²Ñ‹Ğ±ĞµÑ€ĞµĞ¼ ÑÑ‚Ñƒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ½Ğ¸Ğ¶Ğµ
  }

  if(!card.up)return;
  const group=tab[col].slice(row);

  // ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´ Ğ½Ğ° Ñ„ÑƒĞ½Ğ´Ğ°Ğ¼ĞµĞ½Ñ‚
  if(group.length===1){
    for(let i=0;i<4;i++){
      if(canF(card,i)){
        const allEls=Array.from(tabColEl(col).querySelectorAll('.card'));
        fly(allEls[allEls.length-1],document.getElementById('f'+i),()=>{
          snap(); tab[col].pop();
          if(tab[col].length>0&&!tab[col][tab[col].length-1].up){tab[col][tab[col].length-1].up=true;score+=SC.FLIP;}
          found[i].push(card); score+=SC.T2F; moves++; render(); checkWin(); checkAuto();
        });
        return;
      }
    }
  }

  // Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
  const allEls=Array.from(tabColEl(col).querySelectorAll('.card'));
  const faceN=tab[col].filter(c=>!c.up).length;
  allEls.slice(faceN+(row-faceN)).forEach(e=>e.classList.add('selected'));
  sel={cards:group,fromPile:'tableau',fromIdx:col};
}

// â”€â”€ ĞšĞ›Ğ˜Ğš: ĞŸĞ£Ğ¡Ğ¢ĞĞ¯ ĞšĞĞ›ĞĞĞšĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTabEmpty(col){
  if(!sel)return;
  if(canT(sel.cards[0],col)){
    fly(getSelEl(),tabColEl(col),()=>{
      snap(); const from=sel,cards=sel.cards; removeFrom(from);
      tab[col].push(...cards);
      if(from.fromPile==='waste')score+=SC.W2T;
      else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
      moves++; clearSel(); render(); checkAuto();
    });
  } else clearSel();
}

// â”€â”€ ĞšĞ›Ğ˜Ğš: Ğ¤Ğ£ĞĞ”ĞĞœĞ•ĞĞ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onFoundClick(i){
  if(!sel)return;
  if(sel.cards.length!==1){clearSel();return;}
  const card=sel.cards[0];
  if(canF(card,i))doF(card,i,sel.fromPile,sel.fromIdx); else clearSel();
}

function doF(card,fi,fromPile,fromIdx){
  fly(getSelEl(),document.getElementById('f'+fi),()=>{
    snap();
    if(fromPile==='waste'){waste.pop();score+=SC.W2F;}
    else if(fromPile==='tableau'){
      tab[fromIdx].pop();
      if(tab[fromIdx].length>0&&!tab[fromIdx][tab[fromIdx].length-1].up){tab[fromIdx][tab[fromIdx].length-1].up=true;score+=SC.FLIP;}
      score+=SC.T2F;
    }
    found[fi].push(card); moves++; clearSel(); render(); checkWin(); checkAuto();
  });
}

function removeFrom(from){
  if(from.fromPile==='waste'){waste.pop();}
  else if(from.fromPile==='tableau'){
    const col=from.fromIdx;
    tab[col]=tab[col].slice(0,tab[col].length-from.cards.length);
    if(tab[col].length>0&&!tab[col][tab[col].length-1].up){tab[col][tab[col].length-1].up=true;score+=SC.FLIP;}
  } else if(from.fromPile==='foundation'){found[from.fromIdx].pop();}
}

// â”€â”€ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canF(card,i){const p=found[i];if(!p.length)return card.rank==='A';const t=p[p.length-1];return t.suit===card.suit&&ri(card.rank)===ri(t.rank)+1;}
function canT(card,col){const p=tab[col];if(!p.length)return card.rank==='K';const t=p[p.length-1];if(!t.up)return false;return isRed(card.suit)!==isRed(t.suit)&&ri(card.rank)===ri(t.rank)-1;}

// â”€â”€ Ğ’Ğ«Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearSel(){sel=null;document.querySelectorAll('.card.selected').forEach(e=>e.classList.remove('selected'));}
function clearHints(){hintEls.forEach(e=>e&&e.classList.remove('hint-glow'));hintEls=[];}
function getSelEl(){return document.querySelector('.card.selected');}
function tabColEl(col){return document.querySelectorAll('.tableau-col')[col];}

// â”€â”€ ĞĞĞ˜ĞœĞĞ¦Ğ˜Ğ¯ ĞŸĞĞ›ĞĞ¢Ğ (transform, Ğ½Ğµ left/top) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fly(srcEl,tgtEl,cb){
  if(!srcEl){cb();return;}
  const sr=srcEl.getBoundingClientRect();
  const tr=tgtEl.getBoundingClientRect();
  const dx=tr.left-sr.left, dy=tr.top-sr.top;

  const ghost=srcEl.cloneNode(true);
  ghost.classList.remove('selected','hint-glow');
  ghost.classList.add('card-fly');
  ghost.style.left=sr.left+'px'; ghost.style.top=sr.top+'px';
  ghost.style.width=sr.width+'px'; ghost.style.height=sr.height+'px';
  ghost.style.margin='0'; ghost.style.transform='translate(0,0)';
  document.body.appendChild(ghost);
  srcEl.style.visibility='hidden';

  // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ² ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ ĞºĞ°Ğ´Ñ€Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ transition ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    ghost.style.transform='translate('+dx+'px,'+dy+'px)';
  }));

  function done(){ghost.remove();srcEl.style.visibility='';cb();}
  ghost.addEventListener('transitionend',done,{once:true});
  // Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹ ĞµÑĞ»Ğ¸ transitionend Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚
  setTimeout(done,400);
}

// â”€â”€ POINTER DRAG (Ğ¼Ñ‹ÑˆÑŒ + Ñ‚Ğ°Ñ‡ / iPad) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupPointerDrag(el,cards,fromPile,fromIdx){
  // HTML5 drag Ğ´Ğ»Ñ Ğ¼Ñ‹ÑˆĞ¸
  el.setAttribute('draggable','true');
  el.addEventListener('dragstart',e=>{
    e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text','d');
    clearHints(); clearSel(); sel={cards,fromPile,fromIdx};
    setTimeout(()=>el.classList.add('dragging'),0);
  });
  el.addEventListener('dragend',()=>{
    el.classList.remove('dragging');
    document.querySelectorAll('.drop-ok').forEach(e=>e.classList.remove('drop-ok'));
    if(sel)clearSel();
  });

  // Touch drag Ğ´Ğ»Ñ iPad/iPhone
  let touchGhost=null, touchStartX=0, touchStartY=0;

  el.addEventListener('touchstart',e=>{
    if(e.touches.length!==1)return;
    const t=e.touches[0];
    touchStartX=t.clientX; touchStartY=t.clientY;
    clearHints(); clearSel(); sel={cards,fromPile,fromIdx};

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ghost ÑÑ€Ğ°Ğ·Ñƒ
    const sr=el.getBoundingClientRect();
    touchGhost=el.cloneNode(true);
    touchGhost.classList.remove('selected','hint-glow','dragging');
    touchGhost.style.cssText='position:fixed;z-index:8888;pointer-events:none;opacity:.85;'+
      'width:'+sr.width+'px;height:'+sr.height+'px;'+
      'left:'+sr.left+'px;top:'+sr.top+'px;margin:0;transition:none;';
    document.body.appendChild(touchGhost);
    el.style.opacity='.3';
  },{passive:true});

  el.addEventListener('touchmove',e=>{
    if(!touchGhost)return; e.preventDefault();
    const t=e.touches[0];
    const sr=el.getBoundingClientRect();
    const dx=t.clientX-touchStartX, dy=t.clientY-touchStartY;
    touchGhost.style.left=(sr.left+dx)+'px';
    touchGhost.style.top=(sr.top+dy)+'px';

    // ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚Ğ¸Ñ‚ÑŒ drop-Ğ·Ğ¾Ğ½Ñƒ
    document.querySelectorAll('.drop-ok').forEach(e=>e.classList.remove('drop-ok'));
    touchGhost.style.display='none';
    const under=document.elementFromPoint(t.clientX,t.clientY);
    touchGhost.style.display='';
    const dropEl=under?.closest('.pile-slot,.tableau-col');
    if(dropEl&&sel&&canDropOnEl(dropEl,sel.cards))dropEl.classList.add('drop-ok');
  },{passive:false});

  el.addEventListener('touchend',e=>{
    if(!touchGhost){return;}
    const t=e.changedTouches[0];
    touchGhost.style.display='none';
    const under=document.elementFromPoint(t.clientX,t.clientY);
    touchGhost.style.display='';
    touchGhost.remove(); touchGhost=null;
    el.style.opacity='';

    document.querySelectorAll('.drop-ok').forEach(e=>e.classList.remove('drop-ok'));

    const dropEl=under?.closest('.pile-slot,.tableau-col');
    if(dropEl&&sel){
      executeDrop(dropEl,sel.cards);
    } else {
      clearSel();
    }
  },{passive:true});
}

function canDropOnEl(el,cards){
  const id=el.id;
  if(id&&id.startsWith('f')){const i=parseInt(id[1]);return !isNaN(i)&&cards.length===1&&canF(cards[0],i);}
  const col=parseInt(el.dataset.col);
  if(!isNaN(col))return canT(cards[0],col);
  return false;
}

function executeDrop(dropEl,cards){
  const id=dropEl.id;
  if(id&&id.startsWith('f')){
    const i=parseInt(id[1]);
    if(!isNaN(i)&&cards.length===1&&canF(cards[0],i)){doF(cards[0],i,sel.fromPile,sel.fromIdx);}
    else clearSel(); return;
  }
  const col=parseInt(dropEl.dataset.col);
  if(!isNaN(col)&&canT(cards[0],col)){
    snap(); const from=sel; removeFrom(from); tab[col].push(...cards);
    if(from.fromPile==='waste')score+=SC.W2T; else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
    moves++; clearSel(); render(); checkAuto();
  } else clearSel();
}

// HTML5 drop targets
function setupDropTarget(el,canDrop,onDrop){
  el.addEventListener('dragover',e=>{if(!sel)return;if(canDrop(sel.cards)){e.preventDefault();el.classList.add('drop-ok');}});
  el.addEventListener('dragleave',()=>el.classList.remove('drop-ok'));
  el.addEventListener('drop',e=>{e.preventDefault();el.classList.remove('drop-ok');if(!sel)return;if(canDrop(sel.cards))onDrop(sel.cards);else clearSel();});
}

// ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ touchstart Ğ½Ğ° pile-slot Ğ´Ğ»Ñ tap
function attachTouch(el,fn){
  el.addEventListener('touchend',e=>{e.preventDefault();fn();},{passive:false});
}

// â”€â”€ ĞŸĞĞ”Ğ¡ĞšĞĞ—ĞšĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('hint-btn').addEventListener('click',()=>{
  clearSel(); clearHints();
  const hint=findHint();
  if(!hint){showCfg('ğŸ˜”','ĞĞµÑ‚ Ñ…Ğ¾Ğ´Ğ¾Ğ²','Ğ’Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ñ…Ğ¾Ğ´Ğ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾. ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ?','ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°','ĞÑ‚Ğ¼ĞµĞ½Ğ°',()=>deal(),null);return;}
  hint.src&&hint.src.forEach(e=>{if(e){e.classList.add('hint-glow');hintEls.push(e);}});
  hint.tgt&&(hint.tgt.classList.add('hint-glow'),hintEls.push(hint.tgt));
  setTimeout(clearHints,3000);
});

function findHint(){
  const tcols=document.querySelectorAll('.tableau-col');
  const fEl=i=>document.getElementById('f'+i);
  const wTopEl=()=>{const cs=document.getElementById('waste').querySelectorAll('.card');return cs.length?[cs[cs.length-1]]:null;};
  const tTopEl=col=>{const cs=Array.from(tabColEl(col).querySelectorAll('.card')).filter(e=>!e.querySelector('.card-back'));return cs.length?[cs[cs.length-1]]:null;};
  const tGrpEls=(col,row)=>{const all=Array.from(tabColEl(col).querySelectorAll('.card'));const fn=tab[col].filter(c=>!c.up).length;return all.slice(fn+(row-fn));};

  if(waste.length>0){const cd=waste[waste.length-1];for(let i=0;i<4;i++)if(canF(cd,i))return{src:wTopEl(),tgt:fEl(i)};}
  for(let c=0;c<7;c++){if(!tab[c].length)continue;const cd=tab[c][tab[c].length-1];if(!cd.up)continue;for(let i=0;i<4;i++)if(canF(cd,i))return{src:tTopEl(c),tgt:fEl(i)};}
  if(waste.length>0){const cd=waste[waste.length-1];for(let c=0;c<7;c++)if(canT(cd,c))return{src:wTopEl(),tgt:tcols[c]};}
  for(let fc=0;fc<7;fc++)for(let row=0;row<tab[fc].length;row++){const cd=tab[fc][row];if(!cd.up)continue;for(let tc=0;tc<7;tc++){if(tc===fc)continue;if(canT(cd,tc)){const rev=row>0&&!tab[fc][row-1].up,ke=cd.rank==='K'&&!tab[tc].length;if(rev||ke||(row===tab[fc].length-1))return{src:tGrpEls(fc,row),tgt:tcols[tc]};}}}
  for(let fi=0;fi<4;fi++){if(!found[fi].length)continue;const cd=found[fi][found[fi].length-1];for(let c=0;c<7;c++)if(canT(cd,c))return{src:[fEl(fi)],tgt:tcols[c]};}
  if(stock.length>0)return{src:[document.getElementById('stock')],tgt:null};
  return null;
}

// â”€â”€ ĞĞ’Ğ¢ĞĞšĞĞœĞŸĞ›Ğ˜Ğ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAuto(){
  if(autoOffered)return;
  if(!tab.every(col=>col.every(c=>c.up))|| waste.length||stock.length)return;
  autoOffered=true; clearInterval(tint);
  document.getElementById('auto-modal').classList.remove('hidden');
}
document.getElementById('auto-yes').addEventListener('click',()=>{document.getElementById('auto-modal').classList.add('hidden');runAuto();});
document.getElementById('auto-no').addEventListener('click',()=>{document.getElementById('auto-modal').classList.add('hidden');tint=setInterval(()=>{secs++;updateTimer();},1000);});

function runAuto(){
  function step(){
    let moved=false;
    for(let c=0;c<7;c++){if(!tab[c].length)continue;const cd=tab[c][tab[c].length-1];for(let i=0;i<4;i++){if(canF(cd,i)){tab[c].pop();found[i].push(cd);score+=SC.T2F;moves++;moved=true;}}}
    if(waste.length){const cd=waste[waste.length-1];for(let i=0;i<4;i++){if(canF(cd,i)){waste.pop();found[i].push(cd);score+=SC.W2F;moves++;moved=true;}}}
    render();
    if(found.reduce((s,f)=>s+f.length,0)===52){finishWin();return;}
    if(moved)setTimeout(step,100);
  }
  step();
}

// â”€â”€ ĞŸĞĞ‘Ğ•Ğ”Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkWin(){if(found.reduce((s,f)=>s+f.length,0)===52)finishWin();}
function finishWin(){
  clearInterval(tint);
  const bonus=Math.max(0,Math.round(700000/Math.max(secs,1)));
  const final=Math.max(0,score)+bonus;
  document.getElementById('win-score').textContent=final;
  document.getElementById('win-time').textContent=document.getElementById('timer-display').textContent;
  document.getElementById('win-moves').textContent=moves;
  document.getElementById('win-modal').classList.remove('hidden');
  saveGame(final,true);
}

// â”€â”€ CONFIRM HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCfg(icon,title,text,yesLbl,noLbl,onYes,onNo){
  document.getElementById('cfg-icon').textContent=icon;
  document.getElementById('cfg-title').textContent=title;
  document.getElementById('cfg-text').textContent=text;
  document.getElementById('cfg-yes').textContent=yesLbl;
  document.getElementById('cfg-no').textContent=noLbl;
  cfgCb={onYes,onNo};
  document.getElementById('cfg-modal').classList.remove('hidden');
}
document.getElementById('cfg-yes').addEventListener('click',()=>{document.getElementById('cfg-modal').classList.add('hidden');cfgCb?.onYes&&cfgCb.onYes();});
document.getElementById('cfg-no').addEventListener('click',()=>{document.getElementById('cfg-modal').classList.add('hidden');cfgCb?.onNo&&cfgCb.onNo();});

// â”€â”€ ĞšĞĞĞŸĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('undo-btn').addEventListener('click',()=>{
  clearHints();clearSel();if(!hist.length)return;
  const p=hist.pop();stock=p.stock;waste=p.waste;found=p.found;tab=p.tab;score=p.score;moves=p.moves;render();
});
document.getElementById('new-game-btn').addEventListener('click',()=>{
  clearHints();clearSel();
  showCfg('ğŸ”„','ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°?','Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ±ĞµĞ· ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.','Ğ”Ğ°, Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ','ĞÑ‚Ğ¼ĞµĞ½Ğ°',()=>deal(),null);
});
document.getElementById('win-new-game').addEventListener('click',()=>{document.getElementById('win-modal').classList.add('hidden');deal();});

// â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getOrCreate(name){
  const{data:ex}=await db.from('players').select('id').eq('name',name).maybeSingle();
  if(ex)return ex.id;
  const{data:cr}=await db.from('players').insert({name}).select('id').single();
  return cr?.id||null;
}
async function saveGame(sc,completed){
  if(!playerId)return;
  await db.from('games').insert({player_id:playerId,score:Math.max(0,sc),duration_seconds:secs,moves,completed});
}

// â”€â”€ Ğ¡Ğ¢ĞĞ Ğ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('start-btn').addEventListener('click',async()=>{
  const name=document.getElementById('player-name-input').value.trim();
  if(!name){document.getElementById('player-name-input').focus();return;}
  playerName=name; playerId=await getOrCreate(name);
  document.getElementById('name-screen').classList.add('hidden');
  document.getElementById('game-screen').classList.remove('hidden');
  deal();
});
document.getElementById('player-name-input').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('start-btn').click();});
window.addEventListener('beforeunload',()=>{if(playerId&&moves>0)saveGame(Math.max(0,score),false);});
</script>
</body>
</html>