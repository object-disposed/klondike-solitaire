<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Klondike Solitaire</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
  .card{position:relative;cursor:pointer;flex-shrink:0}
  .card-face{position:absolute;inset:0;border-radius:9px;background:#fff;border:1px solid rgba(0,0,0,.13);box-shadow:0 2px 8px rgba(0,0,0,.28);overflow:hidden}
  .card.red .card-face{color:#d62828}
  .card.black .card-face{color:#111}
  .cc{position:absolute;display:flex;flex-direction:column;align-items:center;line-height:1.05}
  .cc.tl{top:3px;left:5px}
  .cc.br{bottom:3px;right:5px;transform:rotate(180deg)}
  .cc .r{font-size:.82rem;font-weight:900}
  .cc .s{font-size:.72rem}
  .card-mid{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.9rem;line-height:1;pointer-events:none}
  .card-royal-art{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.6rem;line-height:1;pointer-events:none}
  .card-back{position:absolute;inset:0;border-radius:9px;background:repeating-linear-gradient(45deg,#b91c1c,#b91c1c 5px,#991818 5px,#991818 10px);border:3px solid #7f1d1d;box-shadow:0 2px 8px rgba(0,0,0,.3)}
  .card-back::after{content:'';position:absolute;inset:5px;border-radius:5px;border:2px solid rgba(255,255,255,.22)}
  .card.selected .card-face,.card.selected .card-back{outline:3px solid #f5a623;box-shadow:0 0 0 3px #f5a623,0 10px 28px rgba(0,0,0,.55)!important;transform:translateY(-8px)}
  .card.hint-glow .card-face{outline:3px solid #22d3ee;animation:hpulse .7s ease-in-out infinite alternate}
  .pile-slot.hint-glow,.tableau-col.hint-glow{border-color:#22d3ee!important;animation:hpulse .7s ease-in-out infinite alternate}
  @keyframes hpulse{from{box-shadow:0 0 0 3px #22d3ee}to{box-shadow:0 0 0 6px #0ea5e9,0 0 22px rgba(14,165,233,.5)}}
  .card-fly{position:fixed;z-index:9999;pointer-events:none;will-change:transform;transition:transform .25s cubic-bezier(.4,0,.2,1)}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#1a6b3a;color:#fff;min-height:100vh;user-select:none;-webkit-user-select:none;touch-action:manipulation}
  .hidden{display:none!important}
  .name-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse at center,#236b45 0%,#0d3a20 100%)}
  .name-card{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);border-radius:20px;padding:48px 40px;text-align:center;width:min(400px,90vw);backdrop-filter:blur(12px)}
  .name-card h1{font-size:2rem;margin-bottom:10px}
  .name-card p{color:rgba(255,255,255,.7);margin-bottom:28px}
  .name-card input{width:100%;padding:14px 18px;font-size:1.1rem;border:2px solid rgba(255,255,255,.25);border-radius:12px;background:rgba(255,255,255,.1);color:#fff;outline:none;margin-bottom:16px;transition:border-color .2s}
  .name-card input::placeholder{color:rgba(255,255,255,.4)}
  .name-card input:focus{border-color:rgba(255,255,255,.6)}
  .btn-primary{display:block;width:100%;padding:14px;font-size:1.1rem;font-weight:600;background:linear-gradient(135deg,#f5a623,#e8891a);color:#fff;border:none;border-radius:12px;cursor:pointer;transition:opacity .2s,transform .1s}
  .btn-primary:hover{opacity:.92}
  .btn-primary:active{transform:scale(.98)}
  .btn-secondary{padding:10px 24px;font-size:1rem;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:10px;cursor:pointer;transition:background .2s}
  .btn-secondary:hover{background:rgba(255,255,255,.25)}
  .stats-link{display:inline-block;margin-top:16px;color:rgba(255,255,255,.6);text-decoration:none;font-size:.95rem;transition:color .2s}
  .stats-link:hover{color:#fff}
  .game-screen{display:flex;flex-direction:column;height:100vh;max-height:100vh;background:#1a6b3a}
  .game-header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:rgba(0,0,0,.3);border-bottom:1px solid rgba(255,255,255,.1);flex-shrink:0;gap:8px}
  .header-stat{display:flex;flex-direction:column;align-items:flex-start;min-width:70px}
  .header-stat.center{align-items:center;flex:1}
  .header-stat.right{align-items:flex-end}
  .stat-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.6)}
  .stat-value{font-size:1.35rem;font-weight:700}
  .header-stats-link{display:flex;align-items:center;gap:5px;padding:6px 12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;text-decoration:none;font-size:.8rem;font-weight:600;transition:background .2s;white-space:nowrap}
  .header-stats-link:hover{background:rgba(255,255,255,.2)}
  .game-area{flex:1;overflow-y:auto;padding:12px 8px 4px;display:flex;flex-direction:column;gap:12px}
  .top-row{display:flex;align-items:flex-start;justify-content:space-between;gap:6px}
  .foundations-row{display:flex;gap:6px}
  .stock-area{display:flex;flex-direction:row-reverse;gap:6px;align-items:flex-start}
  .pile-slot{width:72px;height:104px;border-radius:9px;border:2px dashed rgba(255,255,255,.28);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:border-color .2s;position:relative}
  .pile-slot:hover{border-color:rgba(255,255,255,.5)}
  .pile-suit{font-size:2rem;opacity:.28}
  .pile-empty-icon{font-size:1.4rem;opacity:.32;font-weight:700}
  .waste-wrap{position:relative;height:104px;flex-shrink:0}
  .waste-wrap .card{position:absolute;top:0}
  .tableau-row{display:flex;gap:6px;justify-content:center;padding-bottom:20px}
  .tableau-col{position:relative;width:72px;min-height:104px;flex-shrink:0}
  .tableau-col-bg{position:absolute;inset:0;border-radius:9px;border:2px dashed rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;pointer-events:none}
  .pile-slot.drop-ok,.tableau-col.drop-ok{border-color:#22d3ee!important;border-style:solid!important}
  .game-footer{display:flex;gap:8px;padding:10px 12px 14px;background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.1);flex-shrink:0}
  .footer-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:9px 4px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:14px;color:#fff;font-size:.78rem;font-weight:600;cursor:pointer;transition:background .2s,transform .1s}
  .footer-btn:hover{background:rgba(255,255,255,.2)}
  .footer-btn:active{transform:scale(.96)}
  .footer-btn.primary{background:rgba(245,166,35,.3);border-color:rgba(245,166,35,.5)}
  .footer-btn.primary:hover{background:rgba(245,166,35,.45)}
  .btn-icon{font-size:1.35rem}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px)}
  .modal-content{background:linear-gradient(145deg,#1e4d30,#153a23);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:34px 30px;text-align:center;width:min(360px,88vw);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  .modal-content.sm{padding:26px 22px}
  .win-emoji{font-size:3.2rem;margin-bottom:8px}
  .modal-content h2{font-size:1.7rem;margin-bottom:18px}
  .modal-content p{color:rgba(255,255,255,.75);margin-bottom:18px;line-height:1.5}
  .win-stats{display:flex;gap:14px;justify-content:center;margin-bottom:26px}
  .win-stat{display:flex;flex-direction:column;gap:4px}
  .win-stat span{font-size:.72rem;color:rgba(255,255,255,.6);text-transform:uppercase}
  .win-stat strong{font-size:1.35rem}
  .modal-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .modal-btns .btn-primary{width:auto;padding:10px 22px}
  .modal-btns .btn-secondary{padding:10px 22px}
  .dragging{opacity:.3!important}
  @media(max-width:500px){
    .pile-slot{width:46px;height:68px}
    .waste-wrap{height:68px}
    .tableau-col{width:46px;min-height:68px}
    .tableau-row,.foundations-row,.stock-area,.top-row{gap:3px}
    .cc .r{font-size:.6rem}
    .cc .s{font-size:.55rem}
    .card-mid,.card-royal-art{font-size:1.3rem}
  }
  </style>
</head>
<body>

<div id="name-screen" class="name-screen">
  <div class="name-card">
    <h1>üÉè Klondike Solitaire</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
    <input type="text" id="player-name-input" placeholder="–í–∞—à–µ –∏–º—è" maxlength="30"/>
    <button id="start-btn" class="btn-primary">–ò–≥—Ä–∞—Ç—å</button>
    <a href="stats.html" class="stats-link">üìä –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</a>
  </div>
</div>

<div id="game-screen" class="game-screen hidden">
  <header class="game-header">
    <div class="header-stat">
      <span class="stat-label">–û—á–∫–∏</span>
      <span class="stat-value" id="score-display">0</span>
    </div>
    <div class="header-stat center">
      <span class="stat-value" id="timer-display">00:00</span>
    </div>
    <div class="header-stat right">
      <span class="stat-label">–•–æ–¥—ã</span>
      <span class="stat-value" id="moves-display">0</span>
    </div>
    <a href="stats.html" class="header-stats-link">üìä –†–µ–π—Ç–∏–Ω–≥</a>
  </header>
  <main class="game-area">
    <div class="top-row">
      <div class="foundations-row">
        <div class="pile-slot" id="f0"><span class="pile-suit">‚ô†</span></div>
        <div class="pile-slot" id="f1"><span class="pile-suit">‚ô•</span></div>
        <div class="pile-slot" id="f2"><span class="pile-suit">‚ô¶</span></div>
        <div class="pile-slot" id="f3"><span class="pile-suit">‚ô£</span></div>
      </div>
      <div class="stock-area">
        <div class="pile-slot" id="stock"><span class="pile-empty-icon">‚Ü∫</span></div>
        <div class="waste-wrap" id="waste"></div>
      </div>
    </div>
    <div class="tableau-row" id="tableau"></div>
  </main>
  <footer class="game-footer">
    <button class="footer-btn" id="undo-btn"><span class="btn-icon">‚Ü©</span><span>–û—Ç–º–µ–Ω–∞</span></button>
    <button class="footer-btn primary" id="new-game-btn"><span class="btn-icon">üÉè</span><span>–ù–æ–≤–∞—è –∏–≥—Ä–∞</span></button>
    <button class="footer-btn" id="hint-btn"><span class="btn-icon">üí°</span><span>–ü–æ–¥—Å–∫–∞–∑–∫–∞</span></button>
  </footer>
</div>

<!-- –ü–æ–±–µ–¥–∞ -->
<div id="win-modal" class="modal hidden">
  <div class="modal-content">
    <div class="win-emoji">üéâ</div><h2>–ü–æ–±–µ–¥–∞!</h2>
    <div class="win-stats">
      <div class="win-stat"><span>–û—á–∫–∏</span><strong id="win-score"></strong></div>
      <div class="win-stat"><span>–í—Ä–µ–º—è</span><strong id="win-time"></strong></div>
      <div class="win-stat"><span>–•–æ–¥—ã</span><strong id="win-moves"></strong></div>
    </div>
    <div class="modal-btns">
      <button class="btn-primary" id="win-new-game">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      <a href="stats.html" class="btn-secondary" style="text-decoration:none;display:inline-flex;align-items:center">üìä –†–µ–π—Ç–∏–Ω–≥</a>
    </div>
  </div>
</div>

<!-- –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç -->
<div id="auto-modal" class="modal hidden">
  <div class="modal-content sm">
    <div style="font-size:2rem;margin-bottom:8px">ü§ñ</div>
    <h2>–ü–∞—Ä—Ç–∏—è –≤—ã–∏–≥—Ä–∞–Ω–∞!</h2>
    <p>–í—Å–µ –∫–∞—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?</p>
    <div class="modal-btns">
      <button class="btn-primary" id="auto-yes">–î–∞, –∑–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <button class="btn-secondary" id="auto-no">–ù–µ—Ç, —Å–∞–º</button>
    </div>
  </div>
</div>

<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π confirm -->
<div id="cfg-modal" class="modal hidden">
  <div class="modal-content sm">
    <div id="cfg-icon" style="font-size:2rem;margin-bottom:8px">üîÑ</div>
    <h2 id="cfg-title">–ù–æ–≤–∞—è –∏–≥—Ä–∞?</h2>
    <p id="cfg-text">–¢–µ–∫—É—â–∞—è –ø–∞—Ä—Ç–∏—è –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</p>
    <div class="modal-btns">
      <button class="btn-primary" id="cfg-yes">–î–∞</button>
      <button class="btn-secondary" id="cfg-no">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://ncdajiaffqbmqamrpsfz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_YxIguOiNADys-g1G6teUwA_qtKYEV6e';
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

const SUITS  = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS  = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RED    = new Set(['‚ô•','‚ô¶']);
const ROYALS = {
  'J‚ô†':'üßô','J‚ô•':'ü§¥','J‚ô¶':'ü§µ','J‚ô£':'üßù',
  'Q‚ô†':'üë∏','Q‚ô•':'üë©‚Äçü¶∞','Q‚ô¶':'üßù‚Äç‚ôÄÔ∏è','Q‚ô£':'üßú‚Äç‚ôÄÔ∏è',
  'K‚ô†':'üëë','K‚ô•':'ü§¥','K‚ô¶':'üë®‚Äçü¶≥','K‚ô£':'üßô‚Äç‚ôÇÔ∏è'
};
const isRed = s => RED.has(s);
const ri    = r => RANKS.indexOf(r);
const clone = o => JSON.parse(JSON.stringify(o));
const CW  = () => window.innerWidth <= 500 ? 46 : 72;
const CH  = () => window.innerWidth <= 500 ? 68 : 104;
const OV  = () => window.innerWidth <= 500 ? 20 : 28;
const WOF = () => window.innerWidth <= 500 ? 13 : 18;
const SC  = { W2T:5, W2F:10, T2F:10, FLIP:5, STOCK:-2, F2T:-15 };

let playerName='', playerId=null;
let stock=[], waste=[], found=[[],[],[],[]], tab=[[],[],[],[],[],[],[]];
let score=0, moves=0, secs=0;
let tint=null, hist=[], sel=null, hintEls=[];
let autoOffered=false, cfgCb=null;

function buildDeck(){return SUITS.flatMap(s=>RANKS.map(r=>({suit:s,rank:r,up:false})));}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function snap(){hist.push({stock:clone(stock),waste:clone(waste),found:clone(found),tab:clone(tab),score,moves});if(hist.length>120)hist.shift();}

// ‚îÄ‚îÄ –†–ê–ó–î–ê–ß–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deal(){
  clearInterval(tint); secs=0;
  const deck=shuffle(buildDeck());
  tab=[[],[],[],[],[],[],[]]; found=[[],[],[],[]];
  waste=[]; stock=[]; score=0; moves=0; hist=[];
  sel=null; hintEls=[]; autoOffered=false;
  let idx=0;
  for(let c=0;c<7;c++) for(let r=0;r<=c;r++){const cd=deck[idx++];cd.up=(r===c);tab[c].push(cd);}
  while(idx<deck.length) stock.push(deck[idx++]);
  render();
  updateTimer();
  tint=setInterval(()=>{secs++;updateTimer();},1000);
}

function updateTimer(){
  document.getElementById('timer-display').textContent=
    String(Math.floor(secs/60)).padStart(2,'0')+':'+String(secs%60).padStart(2,'0');
}

// ‚îÄ‚îÄ –ö–ê–†–¢–û–ß–ù–´–ô –≠–õ–ï–ú–ï–ù–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkCard(card){
  const cw=CW(), ch=CH();
  const el=document.createElement('div');
  el.className='card '+(isRed(card.suit)?'red':'black');
  el.style.width=cw+'px'; el.style.height=ch+'px';
  el.dataset.r=card.rank; el.dataset.s=card.suit;
  if(!card.up){const b=document.createElement('div');b.className='card-back';el.appendChild(b);return el;}
  const face=document.createElement('div'); face.className='card-face';
  const tl=document.createElement('div'); tl.className='cc tl';
  tl.innerHTML='<span class="r">'+card.rank+'</span><span class="s">'+card.suit+'</span>';
  const br=document.createElement('div'); br.className='cc br';
  br.innerHTML='<span class="r">'+card.rank+'</span><span class="s">'+card.suit+'</span>';
  face.appendChild(tl); face.appendChild(br);
  const key=card.rank+card.suit;
  const mid=document.createElement('span');
  if(ROYALS[key]){mid.className='card-royal-art';mid.textContent=ROYALS[key];}
  else{mid.className='card-mid';mid.textContent=card.suit;}
  face.appendChild(mid);
  el.appendChild(face);
  return el;
}

// ‚îÄ‚îÄ –†–ï–ù–î–ï–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  renderStock(); renderWaste(); renderFound(); renderTab();
  document.getElementById('score-display').textContent=Math.max(0,score);
  document.getElementById('moves-display').textContent=moves;
}

function renderStock(){
  const el=document.getElementById('stock'); el.innerHTML='';
  if(stock.length>0){
    const c=mkCard({suit:'‚ô†',rank:'A',up:false}); c.style.position='absolute'; el.appendChild(c);
  } else {
    el.innerHTML='<span class="pile-empty-icon">‚Ü∫</span>';
  }
  el.onclick=onStockClick;
}

function onStockClick(){
  clearHints(); clearSel(); snap();
  if(!stock.length){
    stock=waste.slice().reverse().map(c=>({...c,up:false}));
    waste=[]; moves++; render(); return;
  }
  const cd=stock.pop(); cd.up=true; waste.push(cd);
  score=Math.max(0,score+SC.STOCK); moves++; render();
}

function renderWaste(){
  const cont=document.getElementById('waste'); cont.innerHTML='';
  const cw=CW(), wof=WOF(), show=Math.min(3,waste.length);
  cont.style.width=cw+(show>1?(show-1)*wof:0)+'px';
  for(let i=show-1;i>=0;i--){
    const card=waste[waste.length-1-i];
    const el=mkCard(card); el.style.position='absolute';
    el.style.left=(show-1-i)*wof+'px'; el.style.zIndex=show-i;
    if(i===0){
      el.onclick=()=>onWasteClick(el,card);
      setupPointerDrag(el,[card],'waste',-1);
    }
    cont.appendChild(el);
  }
}

function renderFound(){
  for(let i=0;i<4;i++){
    const el=document.getElementById('f'+i); el.innerHTML='';
    if(found[i].length>0){
      const c=mkCard(found[i][found[i].length-1]); c.style.position='absolute'; el.appendChild(c);
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      setupPointerDrag(c, [found[i][found[i].length-1]], 'foundation', i);
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É
      c.onclick = (e) => {
        e.stopPropagation();
        onFoundationCardClick(i, found[i][found[i].length-1]);
      };
    } else {
      el.innerHTML='<span class="pile-suit">'+SUITS[i]+'</span>';
    }
    el.onclick=()=>onFoundClick(i);
    setupDropTarget(el,
      cards=>cards.length===1&&canF(cards[0],i),
      ()=>{if(sel)doF(sel.cards[0],i,sel.fromPile,sel.fromIdx);}
    );
  }
}

function renderTab(){
  const cont=document.getElementById('tableau'); cont.innerHTML='';
  const cw=CW(), ch=CH(), ov=OV();
  for(let col=0;col<7;col++){
    const colEl=document.createElement('div'); colEl.className='tableau-col'; colEl.dataset.col=col;
    const bg=document.createElement('div'); bg.className='tableau-col-bg';
    bg.innerHTML='<span style="font-size:.85rem;opacity:.18">K</span>'; colEl.appendChild(bg);
    colEl.style.width=cw+'px';
    colEl.style.height=tab[col].length>0?(tab[col].length-1)*ov+ch+'px':ch+'px';
    for(let row=0;row<tab[col].length;row++){
      const card=tab[col][row];
      const cEl=mkCard(card); cEl.style.position='absolute';
      cEl.style.top=row*ov+'px'; cEl.style.zIndex=row+1; cEl.style.width=cw+'px';
      if(card.up){
        cEl.onclick=()=>onTabClick(col,row);
        setupPointerDrag(cEl,tab[col].slice(row),'tableau',col);
      }
      colEl.appendChild(cEl);
    }
    setupDropTarget(colEl,
      cards=>canT(cards[0],col),
      ()=>{
        if(!sel)return;
        snap(); const from=sel, cards=sel.cards;
        removeFrom(from); tab[col].push(...cards);
        if(from.fromPile==='waste')score+=SC.W2T;
        else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
        moves++; clearSel(); render(); checkAuto();
      }
    );
    colEl.onclick=e=>{
      if(e.target===colEl||e.target===bg||e.target.classList.contains('tableau-col-bg'))
        onTabEmpty(col);
    };
    cont.appendChild(colEl);
  }
}

// ‚îÄ‚îÄ –ê–í–¢–û–•–û–î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// fromRow –Ω—É–∂–µ–Ω —á—Ç–æ–±—ã –Ω–µ –¥–≤–∏–≥–∞—Ç—å –ö–æ—Ä–æ–ª—è –±–µ–∑ —Å–º—ã—Å–ª–∞
function tryAutoMove(group, fromPile, fromIdx, fromRow, onMoved){
  const card = group[0];

  // –û–¥–∏–Ω–æ—á–Ω–∞—è ‚Üí —Å–Ω–∞—á–∞–ª–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –∏–∑ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞)
  if(group.length === 1 && fromPile !== 'foundation'){
    for(let i=0;i<4;i++){
      if(canF(card,i)){ onMoved('foundation',i); return true; }
    }
  }

  // Tableau ‚Äî –∏—â–µ–º –ø–µ—Ä–≤—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–æ–ª–æ–Ω–∫—É
  for(let c=0;c<7;c++){
    if(fromPile==='tableau' && c===fromIdx) continue; // —Ç–∞ –∂–µ –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫
    if(canT(card,c)){
      // –ë–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ö–æ–¥: –ö–æ—Ä–æ–ª—å –Ω–∞ –ø—É—Å—Ç—É—é –∫–æ–ª–æ–Ω–∫—É –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç —Å–Ω–∏–∑—É
      if(card.rank==='K' && !tab[c].length && fromPile==='tableau' && fromRow===0) continue;
      onMoved('tableau',c);
      return true;
    }
  }
  return false;
}

// ‚îÄ‚îÄ –ö–õ–ò–ö: WASTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onWasteClick(el,card){
  clearHints();
  if(sel?.fromPile==='waste'){ clearSel(); return; }

  const moved = tryAutoMove([card],'waste',-1,0,(destType,destIdx)=>{
    if(destType==='foundation'){
      fly(el,document.getElementById('f'+destIdx),()=>{
        snap(); waste.pop(); found[destIdx].push(card);
        score+=SC.W2F; moves++; render(); checkWin(); checkAuto();
      });
    } else {
      fly(el,tabColEl(destIdx),()=>{
        snap(); waste.pop(); tab[destIdx].push(card);
        score+=SC.W2T; moves++; render(); checkAuto();
      });
    }
  });

  if(!moved){
    el.classList.add('selected');
    sel={cards:[card],fromPile:'waste',fromIdx:-1};
  }
}

// ‚îÄ‚îÄ –ö–õ–ò–ö: TABLEAU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onTabClick(col,row){
  clearHints();
  const card=tab[col][row];

  // –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ —ç—Ç—É –∫–æ–ª–æ–Ω–∫—É
  if(sel){
    if(sel.fromPile==='tableau' && sel.fromIdx===col){ clearSel(); return; }
    if(canT(sel.cards[0],col)){
      const srcEl=getSelEl();
      fly(srcEl,tabColEl(col),()=>{
        snap(); const from=sel, cards=sel.cards;
        removeFrom(from); tab[col].push(...cards);
        if(from.fromPile==='waste')score+=SC.W2T;
        else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
        moves++; clearSel(); render(); checkAuto();
      });
      return;
    }
    clearSel();
    if(!card.up) return;
  }

  if(!card.up) return;
  const group=tab[col].slice(row);

  // –ê–≤—Ç–æ—Ö–æ–¥ –≥—Ä—É–ø–ø—ã (–æ–¥–∏–Ω–æ—á–Ω–∞—è –∏–ª–∏ —Å—Ç–æ–ø–∫–∞)
  const allEls=Array.from(tabColEl(col).querySelectorAll('.card'));
  const srcEl=allEls[row]; // –≤–µ—Ä—Ö–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –≥—Ä—É–ø–ø—ã
  const moved=tryAutoMove(group,'tableau',col,row,(destType,destIdx)=>{
    fly(srcEl, destType==='foundation'
          ? document.getElementById('f'+destIdx)
          : tabColEl(destIdx),
    ()=>{
      snap();
      // –£–±–∏—Ä–∞–µ–º –≥—Ä—É–ø–ø—É –∏–∑ –∫–æ–ª–æ–Ω–∫–∏
      tab[col]=tab[col].slice(0,row);
      if(tab[col].length>0 && !tab[col][tab[col].length-1].up){
        tab[col][tab[col].length-1].up=true; score+=SC.FLIP;
      }
      if(destType==='foundation'){
        found[destIdx].push(card); score+=SC.T2F; checkWin();
      } else {
        tab[destIdx].push(...group);
      }
      moves++; render(); checkAuto();
    });
  });

  if(!moved){
    // –í—ã–¥–µ–ª–∏—Ç—å –≥—Ä—É–ø–ø—É –≤–∏–∑—É–∞–ª—å–Ω–æ
    const faceN=tab[col].filter(c=>!c.up).length;
    allEls.slice(faceN+(row-faceN)).forEach(e=>e.classList.add('selected'));
    sel={cards:group,fromPile:'tableau',fromIdx:col};
  }
}

// ‚îÄ‚îÄ –ö–õ–ò–ö: –ü–£–°–¢–ê–Ø –ö–û–õ–û–ù–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onTabEmpty(col){
  if(!sel) return;
  if(canT(sel.cards[0],col)){
    fly(getSelEl(),tabColEl(col),()=>{
      snap(); const from=sel, cards=sel.cards;
      removeFrom(from); tab[col].push(...cards);
      if(from.fromPile==='waste')score+=SC.W2T;
      else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
      moves++; clearSel(); render(); checkAuto();
    });
  } else clearSel();
}

// ‚îÄ‚îÄ –ö–õ–ò–ö: –§–£–ù–î–ê–ú–ï–ù–¢ (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onFoundationCardClick(i, card) {
  clearHints();
  if (sel) clearSel(); // –ï—Å–ª–∏ –±—ã–ª–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ–º —Å —ç—Ç–æ–π –∫–∞—Ä—Ç–æ–π

  // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É –≤ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ (—Ç–æ–ª—å–∫–æ –≤ —Ç–∞–±–ª–æ, —Ç.–∫. –≤ –æ—Å–Ω–æ–≤—É –∑–∞–ø—Ä–µ—Ç–∏–ª–∏)
  const moved = tryAutoMove([card], 'foundation', i, 0, (destType, destIdx) => {
    if (destType === 'tableau') {
      const srcEl = document.querySelector(`#f${i} .card`);
      fly(srcEl, tabColEl(destIdx), () => {
        snap();
        found[i].pop();               // —É–±–∏—Ä–∞–µ–º –∏–∑ –æ—Å–Ω–æ–≤—ã
        tab[destIdx].push(card);       // –∫–ª–∞–¥—ë–º –≤ –∫–æ–ª–æ–Ω–∫—É
        score = Math.max(0, score + SC.F2T); // —à—Ç—Ä–∞—Ñ –∑–∞ —Ö–æ–¥ –∏–∑ –æ—Å–Ω–æ–≤—ã
        moves++;
        render();
        checkAuto();
      });
    }
  });

  if (!moved) {
    // –ï—Å–ª–∏ –∞–≤—Ç–æ—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è, –≤—ã–¥–µ–ª—è–µ–º –∫–∞—Ä—Ç—É
    const el = document.querySelector(`#f${i} .card`);
    if (el) {
      el.classList.add('selected');
      sel = { cards: [card], fromPile: 'foundation', fromIdx: i };
    }
  }
}

// ‚îÄ‚îÄ –ö–õ–ò–ö: –§–£–ù–î–ê–ú–ï–ù–¢ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è, –¥–ª—è —Å–ª–æ—Ç–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onFoundClick(i){
  if(!sel) return;
  if(sel.cards.length!==1){ clearSel(); return; }
  const card=sel.cards[0];
  if(canF(card,i)) doF(card,i,sel.fromPile,sel.fromIdx); else clearSel();
}

function doF(card,fi,fromPile,fromIdx){
  fly(getSelEl(),document.getElementById('f'+fi),()=>{
    snap();
    if(fromPile==='waste'){ waste.pop(); score+=SC.W2F; }
    else if(fromPile==='tableau'){
      tab[fromIdx].pop();
      if(tab[fromIdx].length>0&&!tab[fromIdx][tab[fromIdx].length-1].up){
        tab[fromIdx][tab[fromIdx].length-1].up=true; score+=SC.FLIP;
      }
      score+=SC.T2F;
    }
    found[fi].push(card); moves++; clearSel(); render(); checkWin(); checkAuto();
  });
}

function removeFrom(from){
  if(from.fromPile==='waste'){ waste.pop(); }
  else if(from.fromPile==='tableau'){
    const col=from.fromIdx;
    tab[col]=tab[col].slice(0,tab[col].length-from.cards.length);
    if(tab[col].length>0&&!tab[col][tab[col].length-1].up){
      tab[col][tab[col].length-1].up=true; score+=SC.FLIP;
    }
  } else if(from.fromPile==='foundation'){ found[from.fromIdx].pop(); }
}

// ‚îÄ‚îÄ –ü–†–ê–í–ò–õ–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function canF(card,i){
  const p=found[i];
  if(!p.length) return card.rank==='A';
  const t=p[p.length-1];
  return t.suit===card.suit && ri(card.rank)===ri(t.rank)+1;
}
function canT(card,col){
  const p=tab[col];
  if(!p.length) return card.rank==='K';
  const t=p[p.length-1];
  if(!t.up) return false;
  return isRed(card.suit)!==isRed(t.suit) && ri(card.rank)===ri(t.rank)-1;
}

// ‚îÄ‚îÄ –£–¢–ò–õ–ò–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearSel(){sel=null;document.querySelectorAll('.card.selected').forEach(e=>e.classList.remove('selected'));}
function clearHints(){hintEls.forEach(e=>e&&e.classList.remove('hint-glow'));hintEls=[];}
function getSelEl(){return document.querySelector('.card.selected');}
function tabColEl(col){return document.querySelectorAll('.tableau-col')[col];}

// ‚îÄ‚îÄ –ê–ù–ò–ú–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fly(srcEl,tgtEl,cb){
  if(!srcEl){cb();return;}
  const sr=srcEl.getBoundingClientRect();
  const tr=tgtEl.getBoundingClientRect();
  const dx=tr.left-sr.left, dy=tr.top-sr.top;
  const ghost=srcEl.cloneNode(true);
  ghost.classList.remove('selected','hint-glow');
  ghost.classList.add('card-fly');
  ghost.style.cssText+='left:'+sr.left+'px;top:'+sr.top+'px;width:'+sr.width+'px;height:'+sr.height+'px;margin:0;transform:translate(0,0);';
  document.body.appendChild(ghost);
  srcEl.style.visibility='hidden';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    ghost.style.transform='translate('+dx+'px,'+dy+'px)';
  }));
  let done=false;
  function finish(){if(done)return;done=true;ghost.remove();srcEl.style.visibility='';cb();}
  ghost.addEventListener('transitionend',finish,{once:true});
  setTimeout(finish,400);
}

// ‚îÄ‚îÄ POINTER/TOUCH DRAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupPointerDrag(el,cards,fromPile,fromIdx){
  el.setAttribute('draggable','true');
  el.addEventListener('dragstart',e=>{
    e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text','d');
    clearHints(); clearSel(); sel={cards,fromPile,fromIdx};
    setTimeout(()=>el.classList.add('dragging'),0);
  });
  el.addEventListener('dragend',()=>{
    el.classList.remove('dragging');
    document.querySelectorAll('.drop-ok').forEach(e=>e.classList.remove('drop-ok'));
    if(sel)clearSel();
  });

  let tGhost=null, t0x=0, t0y=0, t0l=0, t0t=0;
  el.addEventListener('touchstart',e=>{
    if(e.touches.length!==1)return;
    const t=e.touches[0]; t0x=t.clientX; t0y=t.clientY;
    const sr=el.getBoundingClientRect(); t0l=sr.left; t0t=sr.top;
    clearHints(); clearSel(); sel={cards,fromPile,fromIdx};
    tGhost=el.cloneNode(true);
    tGhost.classList.remove('selected','hint-glow','dragging');
    tGhost.style.cssText='position:fixed;z-index:8888;pointer-events:none;opacity:.85;transition:none;margin:0;width:'+sr.width+'px;height:'+sr.height+'px;left:'+sr.left+'px;top:'+sr.top+'px;';
    document.body.appendChild(tGhost);
    el.style.opacity='.3';
  },{passive:true});

  el.addEventListener('touchmove',e=>{
    if(!tGhost)return; e.preventDefault();
    const t=e.touches[0];
    tGhost.style.left=(t0l+(t.clientX-t0x))+'px';
    tGhost.style.top=(t0t+(t.clientY-t0y))+'px';
    document.querySelectorAll('.drop-ok').forEach(e=>e.classList.remove('drop-ok'));
    tGhost.style.display='none';
    const under=document.elementFromPoint(t.clientX,t.clientY);
    tGhost.style.display='';
    const dropEl=under?.closest('.pile-slot,.tableau-col');
    if(dropEl&&sel&&canDropOnEl(dropEl,sel.cards))dropEl.classList.add('drop-ok');
  },{passive:false});

  el.addEventListener('touchend',e=>{
    if(!tGhost)return;
    const t=e.changedTouches[0];
    tGhost.style.display='none';
    const under=document.elementFromPoint(t.clientX,t.clientY);
    tGhost.remove(); tGhost=null; el.style.opacity='';
    document.querySelectorAll('.drop-ok').forEach(e=>e.classList.remove('drop-ok'));
    const dropEl=under?.closest('.pile-slot,.tableau-col');
    if(dropEl&&sel) executeDrop(dropEl,sel.cards); else clearSel();
  },{passive:true});
}

function canDropOnEl(el,cards){
  if(el.id&&/^f\d$/.test(el.id)){const i=+el.id[1];return cards.length===1&&canF(cards[0],i);}
  const col=+el.dataset.col;
  if(!isNaN(col))return canT(cards[0],col);
  return false;
}
function executeDrop(dropEl,cards){
  if(dropEl.id&&/^f\d$/.test(dropEl.id)){
    const i=+dropEl.id[1];
    if(cards.length===1&&canF(cards[0],i)) doF(cards[0],i,sel.fromPile,sel.fromIdx); else clearSel();
    return;
  }
  const col=+dropEl.dataset.col;
  if(!isNaN(col)&&canT(cards[0],col)){
    snap(); const from=sel; removeFrom(from); tab[col].push(...cards);
    if(from.fromPile==='waste')score+=SC.W2T;
    else if(from.fromPile==='foundation')score=Math.max(0,score+SC.F2T);
    moves++; clearSel(); render(); checkAuto();
  } else clearSel();
}

function setupDropTarget(el,canDrop,onDrop){
  el.addEventListener('dragover',e=>{if(!sel)return;if(canDrop(sel.cards)){e.preventDefault();el.classList.add('drop-ok');}});
  el.addEventListener('dragleave',()=>el.classList.remove('drop-ok'));
  el.addEventListener('drop',e=>{e.preventDefault();el.classList.remove('drop-ok');if(!sel)return;if(canDrop(sel.cards))onDrop(sel.cards);else clearSel();});
}

// ‚îÄ‚îÄ –ü–û–î–°–ö–ê–ó–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('hint-btn').addEventListener('click',()=>{
  clearSel(); clearHints();
  const hint=findHint();
  if(!hint){
    // –ù–µ—Ç —Ö–æ–¥–æ–≤ ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–∏–≥—Ä—ã—à –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É
    saveGame(Math.max(0,score),false);
    showCfg('üòî','–ù–µ—Ç —Ö–æ–¥–æ–≤','–î–æ—Å—Ç—É–ø–Ω—ã—Ö —Ö–æ–¥–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç. –ü–∞—Ä—Ç–∏—è –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞.','–ù–æ–≤–∞—è –∏–≥—Ä–∞','–û—Å—Ç–∞—Ç—å—Å—è',()=>deal(),null);
    return;
  }
  hint.src&&hint.src.forEach(e=>{if(e){e.classList.add('hint-glow');hintEls.push(e);}});
  hint.tgt&&(hint.tgt.classList.add('hint-glow'),hintEls.push(hint.tgt));
  setTimeout(clearHints,3000);
});

function findHint(){
  const tcols=document.querySelectorAll('.tableau-col');
  const fEl=i=>document.getElementById('f'+i);
  const wTopEl=()=>{const cs=document.getElementById('waste').querySelectorAll('.card');return cs.length?[cs[cs.length-1]]:null;};
  const tTopEl=col=>{const cs=Array.from(tabColEl(col).querySelectorAll('.card')).filter(e=>!e.querySelector('.card-back'));return cs.length?[cs[cs.length-1]]:null;};
  // FIX: —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ all.slice(row)
  const tGrpEls=(col,row)=>Array.from(tabColEl(col).querySelectorAll('.card')).slice(row);

  // 1. Waste ‚Üí —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
  if(waste.length>0){const cd=waste[waste.length-1];for(let i=0;i<4;i++)if(canF(cd,i))return{src:wTopEl(),tgt:fEl(i)};}
  // 2. Tableau ‚Üí —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
  for(let c=0;c<7;c++){if(!tab[c].length)continue;const cd=tab[c][tab[c].length-1];if(!cd.up)continue;for(let i=0;i<4;i++)if(canF(cd,i))return{src:tTopEl(c),tgt:fEl(i)};}
  // 3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–ª–æ–¥—É
  if(stock.length>0)return{src:[document.getElementById('stock')],tgt:null};
  // 4. –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–±–æ–π (FIX: –Ω–µ –æ–±—ä—è–≤–ª—è—Ç—å –ø—Ä–æ–∏–≥—Ä—ã—à –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π –æ—Ç–±–æ–π)
  if(!stock.length && waste.length>0)return{src:[document.getElementById('stock')],tgt:null};
  // 5. Waste ‚Üí tableau
  if(waste.length>0){const cd=waste[waste.length-1];for(let c=0;c<7;c++)if(canT(cd,c))return{src:wTopEl(),tgt:tcols[c]};}
  // 6. Tableau ‚Üí tableau
  for(let fc=0;fc<7;fc++)for(let row=0;row<tab[fc].length;row++){
    const cd=tab[fc][row]; if(!cd.up) continue;
    for(let tc=0;tc<7;tc++){
      if(tc===fc) continue;
      if(canT(cd,tc)){
        const hasFaceDown=row>0&&!tab[fc][row-1].up;
        // FIX: –ö–æ—Ä–æ–ª—å –Ω–∞ –ø—É—Å—Ç—É—é –∫–æ–ª–æ–Ω–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ä—Ç—ã —Å–Ω–∏–∑—É
        const kingToEmpty=cd.rank==='K' && !tab[tc].length;
        if(kingToEmpty && row===0) continue; // –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ö–æ–¥
        if(hasFaceDown || kingToEmpty || row===tab[fc].length-1)
          return{src:tGrpEls(fc,row),tgt:tcols[tc]};
      }
    }
  }
  // 7. –§—É–Ω–¥–∞–º–µ–Ω—Ç ‚Üí tableau
  for(let fi=0;fi<4;fi++){if(!found[fi].length)continue;const cd=found[fi][found[fi].length-1];for(let c=0;c<7;c++)if(canT(cd,c))return{src:[fEl(fi)],tgt:tcols[c]};}
  return null;
}

// ‚îÄ‚îÄ –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkAuto(){
  if(autoOffered)return;
  if(!tab.every(col=>col.every(c=>c.up))||waste.length||stock.length)return;
  autoOffered=true; clearInterval(tint);
  document.getElementById('auto-modal').classList.remove('hidden');
}
document.getElementById('auto-yes').addEventListener('click',()=>{document.getElementById('auto-modal').classList.add('hidden');runAuto();});
document.getElementById('auto-no').addEventListener('click',()=>{
  document.getElementById('auto-modal').classList.add('hidden');
  tint=setInterval(()=>{secs++;updateTimer();},1000);
});

function runAuto(){
  function step(){
    let moved=false;
    for(let c=0;c<7;c++){if(!tab[c].length)continue;const cd=tab[c][tab[c].length-1];for(let i=0;i<4;i++){if(canF(cd,i)){tab[c].pop();found[i].push(cd);score+=SC.T2F;moves++;moved=true;}}}
    if(waste.length){const cd=waste[waste.length-1];for(let i=0;i<4;i++){if(canF(cd,i)){waste.pop();found[i].push(cd);score+=SC.W2F;moves++;moved=true;}}}
    render();
    if(found.reduce((s,f)=>s+f.length,0)===52){finishWin();return;}
    if(moved)setTimeout(step,100);
  }
  step();
}

// ‚îÄ‚îÄ –ü–û–ë–ï–î–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkWin(){if(found.reduce((s,f)=>s+f.length,0)===52)finishWin();}
function finishWin(){
  clearInterval(tint);
  const bonus=Math.max(0,Math.round(700000/Math.max(secs,1)));
  const final=Math.max(0,score)+bonus;
  document.getElementById('win-score').textContent=final;
  document.getElementById('win-time').textContent=document.getElementById('timer-display').textContent;
  document.getElementById('win-moves').textContent=moves;
  document.getElementById('win-modal').classList.remove('hidden');
  saveGame(final,true);
}

// ‚îÄ‚îÄ CONFIRM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCfg(icon,title,text,yesLbl,noLbl,onYes,onNo){
  document.getElementById('cfg-icon').textContent=icon;
  document.getElementById('cfg-title').textContent=title;
  document.getElementById('cfg-text').textContent=text;
  document.getElementById('cfg-yes').textContent=yesLbl;
  document.getElementById('cfg-no').textContent=noLbl;
  cfgCb={onYes,onNo};
  document.getElementById('cfg-modal').classList.remove('hidden');
}
document.getElementById('cfg-yes').addEventListener('click',()=>{document.getElementById('cfg-modal').classList.add('hidden');cfgCb?.onYes&&cfgCb.onYes();});
document.getElementById('cfg-no').addEventListener('click',()=>{document.getElementById('cfg-modal').classList.add('hidden');cfgCb?.onNo&&cfgCb.onNo();});

// ‚îÄ‚îÄ –ö–ù–û–ü–ö–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('undo-btn').addEventListener('click',()=>{
  clearHints(); clearSel();
  if(!hist.length)return;
  const p=hist.pop(); stock=p.stock;waste=p.waste;found=p.found;tab=p.tab;score=p.score;moves=p.moves; render();
});
document.getElementById('new-game-btn').addEventListener('click',()=>{
  clearHints(); clearSel();
  // FIX: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–∞—Ä—Ç–∏—é –∫–∞–∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—É—é –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π
  showCfg('üîÑ','–ù–æ–≤–∞—è –∏–≥—Ä–∞?','–¢–µ–∫—É—â–∞—è –ø–∞—Ä—Ç–∏—è –±—É–¥–µ—Ç –∑–∞—Å—á–∏—Ç–∞–Ω–∞ –∫–∞–∫ –ø—Ä–æ–∏–≥—Ä—ã—à.','–î–∞, –Ω–∞—á–∞—Ç—å','–û—Ç–º–µ–Ω–∞',
    ()=>{ saveGame(Math.max(0,score),false); deal(); }, null);
});
document.getElementById('win-new-game').addEventListener('click',()=>{document.getElementById('win-modal').classList.add('hidden');deal();});

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getOrCreate(name){
  const{data:ex}=await db.from('players').select('id').eq('name',name).maybeSingle();
  if(ex)return ex.id;
  const{data:cr}=await db.from('players').insert({name}).select('id').single();
  return cr?.id||null;
}
async function saveGame(sc,completed){
  if(!playerId)return;
  await db.from('games').insert({player_id:playerId,score:Math.max(0,sc),duration_seconds:secs,moves,completed});
}

// ‚îÄ‚îÄ –°–¢–ê–†–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('start-btn').addEventListener('click',async()=>{
  const name=document.getElementById('player-name-input').value.trim();
  if(!name){document.getElementById('player-name-input').focus();return;}
  playerName=name; playerId=await getOrCreate(name);
  document.getElementById('name-screen').classList.add('hidden');
  document.getElementById('game-screen').classList.remove('hidden');
  deal();
});
document.getElementById('player-name-input').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('start-btn').click();});
window.addEventListener('beforeunload',()=>{if(playerId&&moves>0)saveGame(Math.max(0,score),false);});
</script>
</body>
</html>