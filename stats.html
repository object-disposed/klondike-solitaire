<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî Klondike Solitaire</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="stats-page">
    <header class="stats-header">
      <a href="index.html" class="back-link">‚Üê –ò–≥—Ä–∞—Ç—å</a>
      <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
    </header>
    <section class="podium-section">
      <div class="podium" id="podium"><div class="loading-msg">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </section>
    <section class="stats-section">
      <h2>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
      <div class="table-wrap">
        <table class="stats-table">
          <thead><tr><th>#</th><th>–ò–≥—Ä–æ–∫</th><th>–õ—É—á—à–∏–π —Å—á—ë—Ç</th><th>–ü–æ–±–µ–¥—ã</th><th>% –ø–æ–±–µ–¥</th><th>–ú–∏–Ω. —Ö–æ–¥–æ–≤</th><th>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–±–µ–¥–∞</th></tr></thead>
          <tbody id="leaderboard-body"><tr><td colspan="7" class="loading-msg">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
        </table>
      </div>
    </section>
    <section class="stats-section">
      <h2>üéØ –†–µ–∫–æ—Ä–¥—ã</h2>
      <div class="records-cards" id="records-cards"><div class="loading-msg">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </section>
    <section class="stats-section">
      <h2>üîç –ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞</h2>
      <div class="player-search">
        <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞"/>
        <button class="btn-primary" id="search-btn">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="player-profile" class="player-profile hidden"></div>
    </section>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  const SUPABASE_URL = 'https://ncdajiaffqbmqamrpsfz.supabase.co'
  const SUPABASE_KEY = 'sb_publishable_YxIguOiNADys-g1G6teUwA_qtKYEV6e'
  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  function fmt(sec){if(!sec&&sec!==0)return'‚Äî';return String(Math.floor(sec/60)).padStart(2,'0')+':'+String(sec%60).padStart(2,'0');}

  async function loadLeaderboard(){
    const{data:games}=await db.from('games').select('player_id,score,duration_seconds,moves,completed,players(name)');
    if(!games||!games.length){
      ['leaderboard-body','podium','records-cards'].forEach(id=>document.getElementById(id).innerHTML='<div class="loading-msg">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –ø–∞—Ä—Ç–∏—é!</div>');
      return;
    }
    const players={};
    for(const g of games){
      const name=g.players?.name||'Unknown';
      if(!players[name])players[name]={name,scores:[],wins:[],all:[]};
      players[name].all.push(g);
      if(g.completed)players[name].wins.push(g);
      players[name].scores.push(g.score);
    }
    const rows=Object.values(players).map(p=>({
      name:p.name,bestScore:Math.max(...p.scores),wins:p.wins.length,total:p.all.length,
      winPct:Math.round((p.wins.length/p.all.length)*100),
      minMoves:p.wins.length?Math.min(...p.wins.map(g=>g.moves)):null,
      fastestWin:p.wins.length?Math.min(...p.wins.map(g=>g.duration_seconds)):null
    })).sort((a,b)=>b.bestScore-a.bestScore);

    document.getElementById('leaderboard-body').innerHTML=rows.map((r,i)=>`
      <tr class="${i<3?'top-'+(i+1):''}">
        <td>${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</td>
        <td class="player-name">${r.name}</td>
        <td><strong>${r.bestScore}</strong></td>
        <td>${r.wins}/${r.total}</td>
        <td>${r.winPct}%</td>
        <td>${r.minMoves??'‚Äî'}</td>
        <td>${r.fastestWin!==null?fmt(r.fastestWin):'‚Äî'}</td>
      </tr>`).join('');

    const top3=rows.slice(0,3);
    const medals=['ü•á','ü•à','ü•â'],order=top3.length>=3?[1,0,2]:top3.map((_,i)=>i);
    document.getElementById('podium').innerHTML=order.map(i=>!top3[i]?'':
      `<div class="podium-card rank-${i+1}">
        <div class="podium-medal">${medals[i]}</div>
        <div class="podium-name">${top3[i].name}</div>
        <div class="podium-score">${top3[i].bestScore} pts</div>
        <div class="podium-detail">${top3[i].wins} –ø–æ–±–µ–¥</div>
      </div>`).join('');

    const allWins=games.filter(g=>g.completed);
    const best=games.reduce((m,g)=>g.score>m.score?g:m,games[0]);
    const fast=allWins.length?allWins.reduce((m,g)=>g.duration_seconds<m.duration_seconds?g:m,allWins[0]):null;
    const minM=allWins.length?allWins.reduce((m,g)=>g.moves<m.moves?g:m,allWins[0]):null;
    document.getElementById('records-cards').innerHTML=`
      <div class="record-card"><div class="rec-icon">üèÜ</div><div class="rec-label">–õ—É—á—à–∏–π —Å—á—ë—Ç</div><div class="rec-value">${best.score}</div><div class="rec-who">${best.players?.name||'‚Äî'}</div></div>
      <div class="record-card"><div class="rec-icon">‚ö°</div><div class="rec-label">–ë—ã—Å—Ç—Ä–∞—è –ø–æ–±–µ–¥–∞</div><div class="rec-value">${fast?fmt(fast.duration_seconds):'‚Äî'}</div><div class="rec-who">${fast?.players?.name||'‚Äî'}</div></div>
      <div class="record-card"><div class="rec-icon">üéØ</div><div class="rec-label">–ú–∏–Ω–∏–º—É–º —Ö–æ–¥–æ–≤</div><div class="rec-value">${minM?.moves||'‚Äî'}</div><div class="rec-who">${minM?.players?.name||'‚Äî'}</div></div>
      <div class="record-card"><div class="rec-icon">üéÆ</div><div class="rec-label">–í—Å–µ–≥–æ –ø–∞—Ä—Ç–∏–π</div><div class="rec-value">${games.length}</div><div class="rec-who">${games.filter(g=>g.completed).length} –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div></div>`;
  }

  async function loadProfile(name){
    const{data:player}=await db.from('players').select('id,name,created_at').eq('name',name).maybeSingle();
    const prof=document.getElementById('player-profile');
    if(!player){prof.innerHTML='<p class="loading-msg">–ò–≥—Ä–æ–∫ "'+name+'" –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';prof.classList.remove('hidden');return;}
    const{data:games}=await db.from('games').select('*').eq('player_id',player.id).order('created_at',{ascending:false});
    if(!games||!games.length){prof.innerHTML='<p class="loading-msg">'+name+' –µ—â—ë –Ω–µ —Å—ã–≥—Ä–∞–ª –Ω–∏ –æ–¥–Ω–æ–π –ø–∞—Ä—Ç–∏–∏</p>';prof.classList.remove('hidden');return;}
    const wins=games.filter(g=>g.completed);
    const best=Math.max(...games.map(g=>g.score));
    const avg=Math.round(games.reduce((s,g)=>s+g.score,0)/games.length);
    const winPct=Math.round((wins.length/games.length)*100);
    const fast=wins.length?Math.min(...wins.map(g=>g.duration_seconds)):null;
    const minM=wins.length?Math.min(...wins.map(g=>g.moves)):null;
    let cur=0,max=0,str=0;
    for(const g of [...games].reverse()){if(g.completed){str++;max=Math.max(max,str);}else str=0;}
    for(const g of games){if(g.completed)cur++;else break;}
    prof.innerHTML=`
      <div class="profile-header"><h3>${player.name}</h3><span class="profile-since">–ò–≥—Ä–∞–µ—Ç —Å ${new Date(player.created_at).toLocaleDateString('ru-RU')}</span></div>
      <div class="profile-grid">
        <div class="profile-stat"><span>–ü–∞—Ä—Ç–∏–π</span><strong>${games.length}</strong></div>
        <div class="profile-stat"><span>–ü–æ–±–µ–¥</span><strong>${wins.length}</strong></div>
        <div class="profile-stat"><span>% –ø–æ–±–µ–¥</span><strong>${winPct}%</strong></div>
        <div class="profile-stat"><span>–õ—É—á—à–∏–π —Å—á—ë—Ç</span><strong>${best}</strong></div>
        <div class="profile-stat"><span>–°—Ä–µ–¥–Ω–∏–π —Å—á—ë—Ç</span><strong>${avg}</strong></div>
        <div class="profile-stat"><span>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–±–µ–¥–∞</span><strong>${fast!==null?fmt(fast):'‚Äî'}</strong></div>
        <div class="profile-stat"><span>–ú–∏–Ω. —Ö–æ–¥–æ–≤</span><strong>${minM??'‚Äî'}</strong></div>
        <div class="profile-stat"><span>–¢–µ–∫. —Å–µ—Ä–∏—è</span><strong>${cur} üî•</strong></div>
        <div class="profile-stat"><span>–ú–∞–∫—Å. —Å–µ—Ä–∏—è</span><strong>${max}</strong></div>
      </div>
      <h4 style="margin:16px 0 10px">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–∞—Ä—Ç–∏–π</h4>
      <div class="table-wrap"><table class="stats-table">
        <thead><tr><th>–ò—Ç–æ–≥</th><th>–°—á—ë—Ç</th><th>–í—Ä–µ–º—è</th><th>–•–æ–¥—ã</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody>${games.slice(0,10).map(g=>'<tr><td>'+(g.completed?'‚úÖ':'‚ùå')+'</td><td>'+g.score+'</td><td>'+fmt(g.duration_seconds)+'</td><td>'+g.moves+'</td><td>'+new Date(g.created_at).toLocaleDateString('ru-RU')+'</td></tr>').join('')}</tbody>
      </table></div>`;
    prof.classList.remove('hidden');
  }

  document.getElementById('search-btn').addEventListener('click',()=>{const n=document.getElementById('search-input').value.trim();if(n)loadProfile(n);});
  document.getElementById('search-input').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('search-btn').click();});
  loadLeaderboard();
  </script>
</body>
</html>